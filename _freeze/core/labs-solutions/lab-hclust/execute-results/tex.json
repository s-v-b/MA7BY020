{
  "hash": "70268f6628e6e6be46614362ec375a93",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Lab: Hierarchical Clustering\"\ndate: \"2026-01-11 22:22:12.432836\"\n\nexecute:\n  echo: true\n  eval: true\n  collapse: true\n  message: false\n  warning: false\n\nformat:\n  html:\n    output-file: lab-hclust.html\n  pdf:\n    output-file: lab-hclust.pdf\n\nengine: knitr\n---\n\n\n\n\n::: {layout=\"[80,20]\"}\n\n::: {#first-column}\n\n|                            |\n|:---------------------------|\n| {{< var curriculum >}}     |\n| {{< var university >}}     |\n| Ann√©e {{< var year >}}     |\n| {{< var homepage >}}       |\n| {{< var moodle >}}         |\n\n\n::: \n\n::: {#second-column}\n![](/images/UniversiteParis_monogramme_couleur_RVB.png){align=\"right\" style=\"size:50px;\" width=75}\n:::\n\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nstopifnot(\n  require(gt),\n  require(skimr),\n  require(GGally),\n  require(patchwork),\n  require(ggforce),\n  require(glue),\n  require(ggfortify),\n  require(ggvoronoi),\n  require(magrittr),\n  require(broom),\n  require(ggdendro),\n  require(dendextend),\n  require(plotly),\n  require(tidyverse)\n)\n\ntidymodels::tidymodels_prefer(quiet = TRUE)\n\nold_theme <-theme_set(\n  theme_minimal(base_size=9, \n                base_family = \"Helvetica\")\n)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nknitr::opts_chunk$set(\n  message = FALSE,\n  warning = FALSE,\n  comment=NA,\n  prompt=FALSE,\n  cache=FALSE,\n  echo=TRUE,\n  results='asis'\n)\n```\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\ngc <- options(ggplot2.discrete.colour=\"viridis\")\ngc <- options(ggplot2.discrete.fill=\"viridis\")\ngc <- options(ggplot2.continuous.fill=\"viridis\")\ngc <- options(ggplot2.continuous.colour=\"viridis\")\n```\n:::\n\n\nPreamble\n---------\n\nHierarchical clustering builds *dendrograms*\n\nExplore the data structure: dendrograms (objects of class `dendrogram`) are represented by *lists of lists  with attributes* (not by `tibbles`). \n\nThe dendrograms created from objects of class `hclust` represent *planar binary trees*. \n\n::: {.callout-note}\n\n### Question\n\n- How do you define abstractly planar binary trees?\n- In dendrograms created from objects of class `hclust`, what do the leaf nodes represent? \n- In dendrograms created from objects of class `hclust`, what do the internal nodes represent ?\n\n:::\n\n::: {.callout-tip}\n\nKeep an eye on  [Introduction to dendextend](https://cran.r-project.org/web/packages/dendextend/vignettes/dendextend.html#a-dendrogram-is-a-nested-list-of-lists-with-attributes) by the package author Tal Galili. \n\n\n:::\n\n\nPlaying with a toy dendrogram\n-----------------------------\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndend <- 1:5 %>% \n  dist %>% \n  hclust(method=\"ward.D2\") %>% \n  as.dendrogram\n```\n:::\n\n\nNodes are identified by their prefix order index (note that this depend on the chosen rotation). \n\n\n::: {.cell}\n\n```{.r .cell-code}\ndend %>%  \n  rotate(c(1,2,4,5,3)) %>% \n  get_nodes_attr(\"members\", \n                 id = c(1, 2, 5, 7)) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 5 2 3 1\n```\n\n\n:::\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncophenetic(rotate(dend, c(1,2,4,5,3)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         1        2        3        4\n2 1.000000                           \n3 3.872983 3.872983                  \n4 3.872983 3.872983 1.000000         \n5 3.872983 3.872983 1.732051 1.732051\n```\n\n\n:::\n\n```{.r .cell-code}\ncophenetic(dend)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         1        2        5        3\n2 1.000000                           \n5 3.872983 3.872983                  \n3 3.872983 3.872983 1.732051         \n4 3.872983 3.872983 1.732051 1.000000\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndend %>% \n  rotate(c(1,2,4,5,3)) %>% \n  get_nodes_attr(\"height\") \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 3.872983 1.000000 0.000000 0.000000 1.732051 1.000000 0.000000 0.000000\n[9] 0.000000\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nas.ggdend(rev(dend))\n```\n\n::: {.cell-output-display}\n![](lab-hclust_files/figure-pdf/unnamed-chunk-8-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# kmeans(tibble(x=1:5), centers = 2)\n```\n:::\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get various attributes\ndend %>% \n  get_nodes_attr(\"height\") # node's height\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 3.872983 1.000000 0.000000 0.000000 1.732051 0.000000 1.000000 0.000000\n[9] 0.000000\n```\n\n\n:::\n:::\n\nHow is attributed `height` computed? What is its purpose? \n\nWhat kind of tree traversal is used by `get_nodes_...` helpers?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndend %>% \n  get_nodes_attr(\"members\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 5 2 1 1 3 1 2 1 1\n```\n\n\n:::\n:::\n\n\n\nTweaking a dendrogram\n-----------------------\n\nWhy should we do that? \n\n\nHow should we do that? \n\n\n::: {.cell}\n\n:::\n\n\n\nUSArrests\n---------\n\nWe work on `USArrests` dataset. We want to classify the 50 (united) states on the basis of the arrests profile and the urbanization rate. We rely on hierarchical, bottom-up classification.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(\"USArrests\")\n\nUSArrests <- USArrests %>% \n    tibble::rownames_to_column(var=\"region\")\n\nUSArrests <- USArrests %>%\n    mutate(region = tolower(region))\n\nrownames(USArrests) <- USArrests$region\n\nglimpse(USArrests)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 50\nColumns: 5\n$ region   <chr> \"alabama\", \"alaska\", \"arizona\", \"arkansas\", \"california\", \"co~\n$ Murder   <dbl> 13.2, 10.0, 8.1, 8.8, 9.0, 7.9, 3.3, 5.9, 15.4, 17.4, 5.3, 2.~\n$ Assault  <int> 236, 263, 294, 190, 276, 204, 110, 238, 335, 211, 46, 120, 24~\n$ UrbanPop <int> 58, 48, 80, 50, 91, 78, 77, 72, 80, 60, 83, 54, 83, 65, 57, 6~\n$ Rape     <dbl> 21.2, 44.5, 31.0, 19.5, 40.6, 38.7, 11.1, 15.8, 31.9, 25.8, 2~\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsource(\"./UTILS/make_biotiful.R\")\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmake_biotifoul(USArrests, .f=is.numeric)\n```\n\n::: {.cell-output-display}\n![](lab-hclust_files/figure-pdf/unnamed-chunk-15-1.pdf){fig-pos='H'}\n:::\n:::\n\n\nThe function `dist` is used to calculate pairwise distances between individuals. \n\n::: {.callout-note}\n\n### Question \n\nCompute pairwise distances between rows of `USArrests` (with and without scaling)\n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndist.1 <-  USArrests %>% \n    select(where(is.numeric)) %>% \n    dist()\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndist.2 <- USArrests %>% \n    select(where(is.numeric)) %>% \n    scale %>% \n    dist()\n```\n:::\n\n\n:::::\n\n::: {.callout-note}\n\n### Question\n\nPerform hierarchical clustering on *unscaled* and *scaled* dataset.\n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhcl.1 <- hclust(dist.1, method = \"ward.D2\")\nhcl.2 <- hclust(dist.2, method = \"ward.D2\") # scaled\n```\n:::\n\n\n\n:::::\n\n::: {.callout-note}\n\n### Question\n\n\n\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmutate(USArrests, \n       .cluster = factor(cutree(hcl.1, 5))) %>% \n  inner_join(map_data(\"state\"), by = \"region\") %>%\n  ggplot() +\n  aes(x=long, y=lat, group=region, fill=.cluster) +\n  geom_polygon() +\n  scale_fill_viridis_d() +\n  ggtitle(\"Components of arrest data\") +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](lab-hclust_files/figure-pdf/unnamed-chunk-19-1.pdf){fig-pos='H'}\n:::\n:::\n\n\nThe `dendrogram` class\n----------------------\n\n::: {.callout-note}\n\n### Question\n\nExploration of results of hierarchical clustering (objects of class `hclust`) is facilitated by converting to class `dendrogram`.\n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndend.1 <- hcl.1 %>% \n  as.dendrogram()\n\nlength(dend.1[[1]][[2]])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 2\n```\n\n\n:::\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclass(dend.1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"dendrogram\"\n```\n\n\n:::\n\n```{.r .cell-code}\nclass(unclass(dend.1))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"list\"\n```\n\n\n:::\n\n```{.r .cell-code}\nmethods(class=class(dend.1)) %>% head()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"[[.dendrogram\"            \"all.equal.dendrogram\"    \n[3] \"as.dendrogram.dendrogram\" \"as.ggdend.dendrogram\"    \n[5] \"as.hclust.dendrogram\"     \"click_rotate.dendrogram\" \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndend.1 %>% head()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n--[dendrogram w/ 2 branches and 50 members at h = 701]\n  |--[dendrogram w/ 2 branches and 16 members at h = 141]\n  |  |--[dendrogram w/ 2 branches and 10 members at h = 69.3]\n  |  |  |--[dendrogram w/ 2 branches and 3 members at h = 30.1] ..\n  |  |  `--[dendrogram w/ 2 branches and 7 members at h = 43.4] ..\n  |  `--[dendrogram w/ 2 branches and 6 members at h = 82.3]\n  |     |--[dendrogram w/ 2 branches and 4 members at h = 33.4] ..\n  |     `--[dendrogram w/ 2 branches and 2 members at h = 38.5] ..\n  `--[dendrogram w/ 2 branches and 34 members at h = 353]\n     |--[dendrogram w/ 2 branches and 14 members at h = 106]\n     |  |--[dendrogram w/ 2 branches and 6 members at h = 42.5] ..\n     |  `--[dendrogram w/ 2 branches and 8 members at h = 44.8] ..\n     `--[dendrogram w/ 2 branches and 20 members at h = 163]\n        |--[dendrogram w/ 2 branches and 10 members at h = 38.5] ..\n        `--[dendrogram w/ 2 branches and 10 members at h = 66] ..\netc... \n```\n\n\n:::\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndend.1 %>% \n  ggdendrogram(rotate = TRUE,labels = T) +\n  ggtitle(\"Dendrogram for USArrests\") +\n  ggdendro::theme_dendro() +\n  scale_y_reverse(expand = c(0.2, 0))\n```\n\n::: {.cell-output-display}\n![](lab-hclust_files/figure-pdf/unnamed-chunk-23-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n:::::\n\n::: {.callout-note}\n\n### Question\n\n\n\n:::\n  \n::::: {.content-visible when-profile=\"solution\"}  \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# label(dend.1)\n\ndend.2 <-  as.dendrogram(hcl.1)\n# order it the closest we can to the order of the observations:\ndend.2 <- rotate(dend.2, 1:50)\n# Color the branches based on the clusters:\ndend.2 <- color_branches(dend.2, k=3) #, groupLabels=iris_species)\n# Manually match the labels, as much as possible, to the real classification of the flowers:\n# labels_colors(dend.2) <-\n#    rainbow_hcl(3)[sort_levels_values(\n#       as.numeric(iris[,5])[order.dendrogram(dend.2)]\n#    )]\n```\n:::\n\n\n\n:::::  \n\n\nWard method \n-----------\n\n\nThe `meth=ward.D2` option allows you to aggregate individuals according to the method of Ward, that is, according to the variance.\n\n::: {.callout-note}\n\n### Question\n\nWhat is the distance used? Describe the method of *classification by variance*?\n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\nThe output `clas$height` gives the jump height of the dendrogram to\neach new iteration. In the case of Ward's method, she\nis proportional to the loss of inter-class variance.\n\n\n:::::\n\n::: {.callout-note}\n\n### Question\n\n1. How many groups are there at step 0? at the last step?\n\n2.  How many iterations are there?\n\n3.  Recall the definition of inter-class variance.\n\n4.  What is the inter-class variance at step 0? at the last\nstep? How is it going according to the number of groups\n(or according to the number of iterations)?\n\n5.  By comparing the total inertia and the `clas$height' output,\nfind the coefficient of proportionality between the loss of\ninter-class variance and height of jumps.\n\n\n:::\n\n\nChoice of the number of classes\n-------------------------------\n\n::: {.callout-note}\n\n### Question\n\n1.  Plot the curve corresponding to the loss of variance inter in\nas a function of the number of iterations :\n\n2.  Select the \"optimal\" number of classes.\n\n3.  Verify that, for the number of classes chosen, the number by\nclass is sufficient (we can use the `cutree` function).\n\n4.  These classes can be represented using a dendrogram\n\n5.  You can also colour the leaves of the tree corresponding to\n a class. To do this, install and load the package `dendextend'.\n\n\n:::\n\n\n\nLink with PCA \n-------------\n\n\nWe will represent the classes obtained in the\nfactorial design(s) obtained by the PCA. This will make it possible to represent the classes and describe them according to the variables initials.\n\n\n::: {.callout-note}\n\n### Question\n\nRepresent the coordinates of the individuals in each group in\nthe first factorial plane (with one color for each class).\nThe vector generated by `cutree' can be used to form a\ncolor vector. Interpretation.\n\n\n:::\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmutate(USArrests, \n       .cluster = factor(cutree(hcl.1, 10))) %>% \n  inner_join(map_data(\"state\"), by = \"region\") %>%\n  ggplot() +\n  aes(x=long, y=lat, group=region, fill=.cluster) +\n  geom_polygon() +\n  scale_fill_viridis_d() +\n  ggtitle(\"Components of arrest data\") +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](lab-hclust_files/figure-pdf/unnamed-chunk-25-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#data(france)\n```\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(map_data(\"state\") %>%\n  ggplot() +\n  aes(x=long, \n      y=lat, \n      label=factor(region), \n      fill = factor(region)) +\n  geom_polygon() +\n  scale_fill_viridis_d() +\n  ggtitle(\"USA\") +\n  theme(legend.position = \"none\")) |> \n    ggplotly()\n```\n\n::: {.cell-output-display}\n![](lab-hclust_files/figure-pdf/unnamed-chunk-27-1.pdf){fig-pos='H'}\n:::\n:::\n\n\nCophenetic distance\n-------------------\n\n::: {.callout-note}\n\n### Question\n\n:::\n\n\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n\n::: {.cell}\n\n```{.r .cell-code}\ndist.coph.1 <- cophenetic(dend.1)\n```\n:::\n\n\n\n:::::\n\n\nCophenetic distance between dendrograms \n----------------------------------------\n\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(\"iris\")\n\nhcl.iris <- iris %>% \n  select(where(is.numeric)) %>% \n  scale() %>% \n  dist() %>% \n  hclust(meth=\"ward.D2\")\n\ndend.iris <-  dendro_data(hcl.iris)\n\ndend.iris %$% (\n  ggplot() +\n  geom_segment(data = segments,\n               aes(x = x, y = y,\n                   xend = xend, yend = yend)\n  ) +\n  geom_text(data = labels,\n            aes(x = x, y = y,\n                label = label, hjust = 0),\n            size = 3\n  ) +\n  coord_flip() +\n  scale_y_reverse(expand = c(0.2, 0))\n)\n```\n\n::: {.cell-output-display}\n![](lab-hclust_files/figure-pdf/unnamed-chunk-29-1.pdf){fig-pos='H'}\n:::\n:::\n\n:::::\n\n\n\n\nReferences\n--------------\n\n[`ggdendro`](https://andrie.github.io/ggdendro/)\n\n[`dendroextra`](https://github.com/jefferis/dendroextras)\n\n[`hier_clust`, `tidyclust`](https://tidyclust.tidymodels.org/articles/hier_clust.html)\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}