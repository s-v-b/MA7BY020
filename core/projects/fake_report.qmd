---
title: "LAB: Fake report"
format:
  html:
    output-file: fake-report.html
draft: false

execute: 
  eval: true
  echo: false
  collapse: false

code-tools: 
  source: repo

params:
  truc: html
  year: 2023 
  curriculum: "M1 MIDS & MFA"
  university: "Université Paris Cité"
  homepage: "https://stephane-v-boucheron.fr/courses/isidata"
  moodle: ""

engine: knitr
---



```{r}
#| label: none
#| message: false 
#| warning: false
require(tidyverse)
require(glue)
```


# Motivation

```{r}
#| label: lorem
lorem::ipsum()

```


# Reproducible data gathering 


Data and metadata should be retrieved programmatically. 

Here is an example from the [OECD API documentation](https://www.oecd.org/en/data/insights/data-explainers/2024/09/api.html). Other providers have their own API for example [Eurostat](https://ec.europa.eu/eurostat/web/user-guides/data-browser/api-data-access/api-getting-started#SDMX2.1). 

```{r}
#| label: oecd-api
#| echo: true
#| appendix: false
#| 
url <- "https://sdmx.oecd.org/public/rest/data/OECD.SDD.STES,DSD_STES@DF_CLI/.M.LI...AA...H?startPeriod=2023-02&dimensionAtObservation=AllDimensions&format=csvfilewithlabels"

df <-  read.csv(url)

df |>
  dplyr::select(sample(seq(1,30), size=10)) |>
  tibble::glimpse(width=30)
```

{{< fa hand-point-right >}} Note that in your report, data gathering chunks should go to the appendix. 


# 200 countries, 50 years, 20 lines of code

You should build your report and your presentation around plots and tables.

```{r}
#| ref.label: lorem
```

```{r}
#| label: load_gapminder 
#| appendix: true

# Load the data
#
gapminder <- gapminder::gapminder
```

{{< fa hand-point-right >}} Display tables with style  (no kitsch please).

```{r}
#| label: display_gapminder
#| appendix: true 

#
#
# Using package gt 
#
gapminder |>
  dplyr::slice_sample(n=2, by= continent) |>
  dplyr::mutate(pop=pop/1e6) |>
  gt::gt() |>
  gt::fmt_number(columns=c(pop, lifeExp),decimals=1)|>
  gt::fmt_currency(columns=gdpPercap, use_subunits=FALSE) |>
  gt::cols_label(
    country = "Country",
    continent = "Continent",
    year = "Year",
    lifeExp = "Life Expectancy",
    pop = "Population (Millions Inhab.)", 
    .fn =  stringr::str_to_title
    )
```


```{r}
#| label: theme_scale
#| appendix: true
#
#
# A neater color scale 
#
neat_color_scale <-
      c("Africa" = "#01d4e5",
        "Americas" = "#7dea01" ,
        "Asia" = "#fc5173",
        "Europe" = "#fde803",
        "Oceania" = "#536227")
```


```{r}
#| ref.label: lorem
```

{{< fa hand-point-right >}} Visualization matters

```{r}
#| label: visualize_static_gapminder 
#| appendix: true
#
#
a_year <- sample(gapminder$year, 1)

p <- gapminder |>
    filter(year==a_year) |>
    ggplot() +
    aes(x = gdpPercap) +
    aes(y = lifeExp) +
    aes(size = pop) +
    aes(text = country) +                   #
    aes(fill = continent) +
    aes(color= continent) +
    aes(frame = year) +                     #
    geom_point(alpha=.5) +
    scale_x_log10() +
    scale_size_area(max_size = 15,
                    labels= scales::label_number(scale=1/1e6,
                                                suffix=" M")) +
    scale_fill_manual(values = neat_color_scale) +
    labs(title= glue("Gapminder  {a_year}"),
        x = "Yearly Income per Capita",
        y = "Life Expectancy",
        caption="From sick  and poor (bottom left) to healthy and rich (top right)")

p 

```

# Static with plotly 

```{r}
#| ref.label: lorem
```

{{< fa hand-point-right >}} Interaction and animation shine 
 
```{r}
#| label: static-plotly
#| appendix: true
(p + theme(legend.position = "none")) |> 
    plotly::ggplotly(height = 500, width=750)

```


# Wizardry


```{r}
#| ref.label: lorem
```

```{r}
#| label: animated 
#| appendix: true

(p %+% 
    gapminder + 
    theme(legend.position = "none") +
    ggtitle("Gapminder")) |> 
    plotly::ggplotly(height = 500, width=750)

```



# Appendix 


{{< fa hand-point-right >}} The appendix should contain the code that helped you create the document

```{r}
#| ref.label: lorem
```


```{r}
#| label: chunk-make-appendix
#| ref.label: !expr knitr::all_labels(appendix==TRUE)
#| echo: true
#| eval: false
#| code-fold: false
```
